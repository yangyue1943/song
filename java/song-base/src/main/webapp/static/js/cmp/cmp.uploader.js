/** * Created by 王松华 on 2017/8/25. */(function (cmp, $) {    $.extend(cmp, {        acceptType: {            file: {                title: "Files",                extensions: 'gif,jpg,jpeg,bmp,png,zip,7z,rar,tar,gz,doc,docx,ppt,pptx,xls,xlsx,txt,html,htm,pdf,css,js,xml',                mimeTypes: 'image/*,application/*,text/*'            },            image: {                title: "Images",                extensions: "gif,jpg,jpeg,bmp,png",                mimeTypes: "image/*"            },            doc: {                title: "Documents",                extensions: "doc,docx,ppt,pptx,xls,xlsx,txt,pdf",                mimeTypes: "text/*"            },            compress: {                title: "Compress",                extensions: "zip,7z,rar,tar,gz",                mimeTypes: "application/*,text/*"            }        }    });    cmp.uploader = cmp.create({        init: function () {            this.state = "pending";            this.render();            this.bindData();            this.create();        },        render: function () {            this.id = song.id("uploader");            var tpl = '<div id="' + this.id + '" class="uploader" style="width:' + this.options.width + ';">\n' +                '    <div class="uploader-btns">\n' +                '        <div class="uploader-select">' + (this.options.selectText || '选择文件') + '</div>\n' +                '        <button class="uploader-btn">开始上传</button>\n' +                '    </div>\n' +                '    <div class="uploader-list">\n' +                '    </div>\n' +                '</div>';            this.el.append(tpl);        },        create: function () {            var btn = this.el.find("button.uploader-btn"),                that = this;            this.uploader = WebUploader.create({                multiple: that.options.multiple,                fileNumLimit: that.options.limitTotal,                formData: that.options.formData || {},                fileSingleSizeLimit: that.options.limitSize * 1024 * 1024,                auto: that.options.auto,                // swf文件路径                swf: cmp.view.rootUrl("static/js/uploader/Uploader.swf"),                // 文件接收服务端。                server: cmp.view.rootUrl('uploader/upload'),                // 选择文件的按钮。可选。                // 内部根据当前运行是创建，可能是input元素，也可能是flash.                pick: this.el.find("div.uploader-select"),                // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！                resize: false,                accept: cmp.acceptType[that.options.acceptType]                // 只允许选择文件，可选。                //["image/*","video/*","text/*","audio/*","application/*"]            });            this.uploader.on('fileQueued', function (file) {                that.addQueue(file);            });            this.uploader.on('uploadProgress', function (file, percentage) {                var item = $('#' + file.id),                    progress = item.find('span.uploader-progress'),                    state = item.find("span.uploader-state"),                    p = (percentage * 100).toFixed(1) + "%";                state.text('上传中(' + p + ')');                progress.css('width', p);            });            this.uploader.on('uploadSuccess', function (file, result) {                var item = $('#' + file.id);                item.find('span.uploader-state').text('上传成功');                that.options.data.push(file);            });            this.uploader.on('uploadError', function (file) {                var item = $('#' + file.id);                item.addClass("uploader-error");                item.find('span.uploader-state').text('上传失败');                item.find("span.uploader-progress").addClass("uploader-error");            });            //上传完成            /*this.uploader.on('uploadComplete', function (file) {            });*/            this.uploader.on('all', function (type) {                if (type === 'startUpload') {                    that.state = 'uploading';                } else if (type === 'stopUpload') {                    that.state = 'paused';                } else if (type === 'uploadFinished') {                    that.state = 'done';                }                if (that.state === 'uploading') {                    btn.text('暂停上传');                } else {                    btn.text('开始上传');                }            });            btn.on('click', function () {                if (that.state === 'uploading') {                    that.uploader.stop();                } else {                    that.uploader.upload();                }            });        },        bindData: function () {            var data = this.options.data;            if (!data) {                return;            }            for (var key in data) {                this.addFile(data[key])            }        },        addQueue: function (file) {            /*var file = {                    id: "WU_FILE_0",                    ext: "zip",                    name: "bingo-jar.zip",                    type: "application/zip",                    size: 212112,                    statusText: "",                    lastModifiedDate: ""                };*/            var tpl = ['<a class="uploader-item" id="', file.id, '">',                '            <span class="uploader-progress" style="width:0%"></span>',                '            <span class="uploader-filename">', file.name, '</span>',                '            <span class="uploader-state">等待上传...</span>',                '        </a>']            this.el.find("div.uploader-list").append(tpl.join(''));        },        addFile: function (file) {            var tpl = ['<div class="uploader-file" id="', file.id, '">',                '            <span class="uploader-filename">', file.name, '</span>',                '        </div>'];            this.el.find("div.uploader-list").append(tpl.join(''));        },        removeFile: function (id) {            //删除服务器文件            var url = cmp.view.rootUrl("uploader/remove"),                params = {id: id};            cmp.postAjax(url, params, function (result) {                //删除文件记录【卸载事件，移除dom，清除数据】            });        },        getData: function () {            return this.options.data;        }    });    //默认配置    $.extend(cmp.uploader, {        defaults: {            data: [],            multiple: true,            auto: false,            limitTotal: 10,            limitSize: 5,     //限制单个文件上传大小，单位MB            acceptType: "file"        }    })})(window.cmp, window.jQuery);