/** * Created by 王松华 on 2017/8/25. */(function (cmp, $) {    cmp.uploader = cmp.create({        init: function () {            this.state = "pending";            this.render();            this.bindData(this.options.data);            this.create();        },        render: function () {            this.id = song.id("uploader");            var tpl = '<div id="'+this.id+'" class="uploader" style="width:'+this.options.width+';">\n' +                '    <div class="uploader-btns">\n' +                '        <div class="uploader-select">'+(this.options.selectText || '选择文件')+'</div>\n' +                '        <button class="uploader-btn">开始上传</button>\n' +                '    </div>\n' +                '    <div class="uploader-list">\n' +                '    </div>\n' +                '</div>';            this.el.append(tpl);        },        create:function () {            var btn=this.el.find("button.uploader-btn"),                that=this;            this.uploader = WebUploader.create({                multiple:true,                fileSizeLimit:2,                fileSizeLimit:10*1024,                auto: that.options.auto,                // swf文件路径                swf:  cmp.view.root +"static/js/uploader/Uploader.swf",                // 文件接收服务端。                server: cmp.view.root + 'uploader/upload',                // 选择文件的按钮。可选。                // 内部根据当前运行是创建，可能是input元素，也可能是flash.                pick: this.el.find("div.uploader-select"),                // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！                resize: false                // 只允许选择文件，可选。                //["image/*","video/*","text/*","audio/*","application/*"]                /*,accept: {                    title: 'Images',                    extensions: 'gif,jpg,jpeg,bmp,png',                    mimeTypes: 'image/*'                }*/            });            this.uploader.on('fileQueued', function (file) {                that.addQueue(file);            });            this.uploader.on('uploadProgress', function (file, percentage) {                var item = $('#' + file.id),                    progress = item.find('span.uploader-progress'),                    state = item.find("span.uploader-state"),                    p=(percentage * 100).toFixed(1)+"%";                state.text('上传中('+p+')');                progress.css('width', p);            });            this.uploader.on('uploadSuccess', function (file, result) {                var item=$('#' + file.id);                item.find('span.uploader-state').text('上传成功');            });            this.uploader.on('uploadError', function (file) {                var item=$('#' + file.id);                item.addClass("uploader-error");                item.find('span.uploader-state').text('上传失败');                item.find("span.uploader-progress").addClass("uploader-error");            });            //上传完成            /*this.uploader.on('uploadComplete', function (file) {            });*/            this.uploader.on('all', function (type) {                if (type === 'startUpload') {                    that.state = 'uploading';                } else if (type === 'stopUpload') {                    that.state = 'paused';                } else if (type === 'uploadFinished') {                    that.state = 'done';                }                if (that.state === 'uploading') {                    btn.text('暂停上传');                } else {                    btn.text('开始上传');                }            });            btn.on('click', function () {                if (that.state === 'uploading') {                    that.uploader.stop();                } else {                    that.uploader.upload();                }            });        },        bindData:function (data) {            if (!data){return;}            for (var key in data){                this.addFile(data[key])            }        },        addQueue:function (file) {            /*var file = {                    id: "WU_FILE_0",                    ext: "zip",                    name: "bingo-jar.zip",                    type: "application/zip",                    size: 212112,                    statusText: "",                    lastModifiedDate: ""                };*/            var tpl = ['<a class="uploader-item" id="', file.id, '">',                '            <span class="uploader-progress" style="width:0%"></span>',                '            <span class="uploader-filename">', file.name, '</span>',                '            <span class="uploader-state">等待上传...</span>',                '        </a>']            this.el.find("div.uploader-list").append(tpl.join(''));        },        addFile:function (file) {            var tpl=['<div class="uploader-file" id="', file.id, '">',                '            <span class="uploader-filename">', file.name, '</span>',                '        </div>'];            this.el.find("div.uploader-list").append(tpl.join(''));        }    });    $.extend(cmp.uploader.defaults,{        auto:false    })})(window.cmp, window.jQuery);